## 监控类目总结

从服务器的角度，将监控分为preview, 灰度, online。上线时先preview，再灰度，再online，让上线人员有足够的时间和机会发现问题。如果是容器部署，则需要分为容器和实体机监控。

本文的监控列表不一定适用于所有类型的系统，可以根据系统特点选择性使用。

### 硬件级监控

* cpu负载监控: cpu.busy
* 内存占用百分比监控: mem.memused.percent
* 系统负载（1min, 5min, 15min）监控: load.1min, load.5min, load.15min (关注15分钟数量，建议监控值不大于系统cpu核数)
* 系统可用内存：mem.memfree (一般情况下，需大于总内存的2 0%)
* 内存使用量：mem.memused.nocache
* 网卡入流量：net.if.in.busy/iface=bond0
* 网卡出流量：net.if.out.busy/iface=bond0
* 磁盘使用率：disk.io.util/device=sdb
* 磁盘读写速度：disk.io.write_bytes/device=/dev/sdb, disk.io.read_bytes/device=/dev/sdb


### 进程级监控

#### jvm监控

* jvm.mem.used.size: 服务使用内存绝对值，对上边的值在集群中取p995可得内存占用p995
* 按内存分区进行内存占用P995的统计（新声代/老年代/eden/元数据等）
* gc吞吐率(jvm.gc.throughput)：工作时间/(gc时间+工作时间,以分钟为单位)，正常应该大于99%
* gc耗时的绝对时间统计(jvm.gc.time，分区统计),正常应在100ms以内,
* 每分钟gc次数统计(jvm.gc.count，分区统计)，正常每分钟在10以内
* 每分钟old区内存增长(jvm.mem.promotion)，正常应该为0附近，否则可能有内存泄漏
* 每分钟eden区增长统计(振幅过大可能有不合理的内存申请)
* old区内存使用率统计(jvm.mem.usage)，占用率过高可能需要调整jvm参数，或内存泄漏
* 打开的fd统计(jvm.system.openFileDescriptorCount)，跟网络连接的个数有关，正常数值可以根据进程本身判断，一般情况下不会过多，比如20k以上。太多需关注是否有句柄泄漏
* jvm cpu使用率(jvm.system.processCpuPercent)
* jvm io任务排队数量(jvm.netty.pendingTasks)：正常不应该超过100
* jvm堆外内存数量(jvm.directMemory.reservedMemory): 
* dns请求次数统计
* dns请求耗时统计(P99/P995)
* dns请求失败统计


#### 本地缓存监控

 * 本地缓存命中率监控
 * 本地缓存刷新数据耗时
 * 本地缓存占用内存大小
 * 本地缓存load异常统计

#### 异常监控

 * 异常日志数量监控
 *  错误日志数量监控

### 中间件监控

#### rpc监控

* 调用QPS统计监控
* 成功QPS统计监控
* 耗时监控(P99/P995)
* 失败数监控
* rpc下游服务超时配置监控
* 如果有统一的返回格式，可以对rpc返回的错误码进行监控
* 连接池监控（可用连接数量/新建连接耗时等？）


#### 缓存中间件(redis/memcache)监控

* 内存占用百分比监控(已用内存/中间件可用最大内存)
* 访问qps监控
* 耗时统计监控(P99/P995)
* large key监控，large key没有统一的标准，跟key对应的qps以及网卡容量有关，一般情况下，string类型不建议超过10kb，list/set/hash的话不超过5000。由于redis是单线程，过大的key可能导致整个集群性能下降。
* 热点监控: 由于redis单线程特性，而且单个key只能落到单个节点，如果热key访问qps过大（比如超过10w），有可能对集群造成摧毁。
* 访问成功数监控
* 访问失败数监控
* 连接池监控（可用连接数/新建连接耗时）

#### mysql监控

* 慢查询监控
* 耗时监控(P99)
* 总访问QPS监控
* 查询QPS监控
* TPS监控
* 失败数监控
* 每秒返回行数监控
* 连接池监控（可用连接数/新建连接个数、耗时）
* 如果有主从结构，需监控主从延迟
* 如果数据冗余存储，需监控主库/冗余库的diff
* binlog消费延迟

#### mq监控

* consumer消费延迟
* consumer消费延迟消息数
* 消费qps监控
* 消费成功数监控
* 消费失败数监控
* 消费耗时(P99/P995)
* 线程池使用率
* producer阻塞耗时(P99/P995)
* producer生产失败监控

#### schedule监控

* schedule耗时监控
* schedule失败监控
* task运行次数监控(QPM/QPS等)

### 业务级监控

业务级监控通常没有通用普适的监控指标，需要根据业务特点对关键的统计数据进行监控，比如api的访问QPS、每小时订单量、日活、每小时订单金额、直播在线数、点赞数及当天主播开播数等等。

#### http服务通用监控

* 请求QPS/QPM监控，频率不高使用QPM
* 返回结果（业务错误码）监控
* 返回结果（http错误码）监控
* QPS同比监控（可以以天/周/月为单位进行同比监控对比，访问上涨/下跌超过一定阈值进行报警，如果是订单系统，也可以对订单量监控）
* api耗时监控

### 报警与误报

当一个系统越来越庞大时，不可能避免经常会出现一些异常指标，比如异常日志数量、api错误码数量等，此时会导致监控系统产生比较多的误报，如果误报过多，会导致开发/运维错失掉关键的报警信息，导致报警失效。

处理误报问题，比较常用的手段是细化报警指标。

* 将报警分级（P0/P1/P2/P3），比如数据库宕机作为P0级最高报警级别，必须立即处理。
* 细化监控指标。比如异常日志的监控，可以将异常分为核心异常和一般异常监控，核心异常监控一经出现必须处理，而对于一般异常监控，需观察曲线进行分析处理。

### api自动化巡检监控

对于常规的api接口，可以使用api自动化巡检的方式辅助人工发现问题。比如可以定时调用查询订单数量的接口，如果返回失败或者订单数量小于等于0则报警。当然，api自动化巡检有其局限性，比如只能发现部分用户或部分场景下的问题，只能作为发现问题的一种辅助手段。

完备的监控与报警系统是保障系统可靠性的重要条件，但并非充分条件，要使系统充分可靠，除了完整的监控系统外，还需要配套的巡检制度、奖惩规范等。同时，在业务系统的发展演化过程中，也需要对监控系统进行配套的升级与优化。