## 大型网站架构模式

所为模式，即在架构设计上的一些通用方法。

### 通用架构模式

#### 分层

分层是架构设计中的必须手段，如TCP/ip协议，操作系统设计也使用了分层的设计方法。

**为什么要分层**

将大型软件系统规划成各个相互独立、协作的模块，便于独立开发和维护。分层能够对系统的不同部分进行解耦合，从而提升系统的可扩展性和易维护性。

分层架构对系统的高可用、高性能和可扩展有着重要意义，因此，在开发之初就应该划分出良好的分层结构。

**分层的常用手段**

一般情况下，大型网站系统的架构由下到上可以分为存储层、服务层以及应用层。

* 存储层  向上层提供数据访问服务，如数据库、文件系统等
* 服务层  从不同业务中抽象出具体服务，如用户中心、订单中心、商品中心等
* 业务层  负责具体业务和视图展示，如网站首页，搜索框结果列表等

各层还可以根据具体业务进行进一步拆分。

系统分层之后，各层一定职责确定、边界清晰，调用关系一般是由上至下逐层调用，不允许跨层调用以及反向调用。

#### 分割

如果分层是对系统进行横向拆分，分割即对系统进行纵向拆分。

**为什么要分割**

大型网站系统通常含有复杂的业务逻辑，将整块儿业务/服务拆分成高内聚、低耦合的各个模块儿，是系统可扩展的必要条件，对整个系统的可用性、高性能也至关重要。

**怎么分割**

纵向拆分的方法根据业务各有不同，一般而言，服务层的拆分可用通过业务层的抽象得来，理想情况下，服务层的拆分要尽可能可复用。例如一个典型电商系统的服务层可以分为商品中心、商家中心、用户中心等服务，各个服务均可向上层业务提供数据。应用层可以根据业务进行分割，例如将购物、论坛、搜索、广告分割成不同应用，由独立的团队负责。

与分层类似，纵向分割后各模块儿的职责与边界应尽可能清晰确定。

#### 分布式

**为什么分布式**

将不同的服务部署在不同的服务器上，可以充分利用服务器的计算资源，提升系统的性能和可用性。但是，分布式服务中，服务间通过网络通信可能会增加开销；单个服务的性能/可用性问题有可能影响整个系统；数据在分布式环境下的一致性保障也比较困难。此外，服务的监控、治理也是分布式系统的难点之一。

**分布式的常用手段**

* 应用和服务的分布式部署

	改善性能，提升系统扩展性。

* 动静分离

	静态资源CDN、多地部署，提升性能。

* 分布式存储

	关系数据库的分布式部署（分库分表，主从结构）；NOSQL产品。

* 分布式计算

	Hadoop、storm等计算框架

* 分布式锁/分布式事务/分布式配置

	分布式系统中需要经常用到的组件

#### 集群

集群部署可以提升系统性能，也可以提升整个系统的可用性。分布式集群系统的难点在于大型服务的治理和监控，需要各类中间件的支撑。

#### 缓存

大多数互联网系统都有读多写少的特点。使用缓存可以减轻DB压力，提升系统性能。缓存又可以分为本地缓存和分布式缓存两种。

使用缓存有两个条件，一是数据热点不均匀，二十某个时间段内有效，不会很快过期。

缓存设计中的难点：

* 缓存哪些数据：根据具体业务场景进行选择
* 缓存的数据一致性，如何保证不读脏数据：弱一致性，强一致性
* 如何保证缓存不被击穿：根据业务进行设计，避免大量缓存同时失效
* 分布式缓存的选型：市面上常见的如redis、tair等，对比优缺点

#### 异步

**为什么异步而非同步**

异步是对系统解耦的重要手段之一，交互双方通过消息队列通信，只要数据结构不变，双方功能可以随意变化而不相互影响。

除此之外，异步还有以下优点:

1. 提高整体可用性，消费者故障不会影响生产者提供服务
2. 加快响应速度，生产者放入消息队列后可以立即返回，不需要等待消息被处理
3. 消除并发访问高峰，流量高峰时将请求放入消息队列中依次处理，避免负载压力

当然，采用异步交互时，需要产品侧允许不立即返回消费者的结果。

**异步手段**

系统间的异步通常采用消息队列中间件，使用消息队列时需要关注以下几点：

* 选型：Rabbitmq、kafka、Rocketmq等
* 性能、吞吐：消息队列同样需要高性能，否则可能成为系统性能瓶颈
* 高可用：消息队列的高可用也是整个系统高可用的一环

#### 冗余

冗余也是实现高可用的重要手段，应用服务需要冗余部署，避免单点；数据服务同样需要冗余，保证数据安全。数据库除了定期备份外，还需要主从结构实现热备。

同城灾备、异地灾备，网站程序和数据实时同步到多个灾备中心。

#### 自动化

大型网站系统通常有成千上万台服务器组成，人工修改、发布、维护难度极大，自动化是一个重要手段。

系统运维的自动化环节涉及各个方面如

* 自动化代码管理
* 自动化部署
* 自动化测试
* 自动化报警
* 自动化降级
* 自动化故障转移

等等

#### 安全

关键数据密文存储，重要数据脱敏打印日志；避免XSS攻击、SQL注入等。

### 新浪微博架构设计

微博层次架构图：

![](http://wenpf.xyz/wp-content/uploads/2020/01/微博.png)

新微博发布推拉结合；多级缓存缓存大V微博；多个数据中心就近访问、灾备。

