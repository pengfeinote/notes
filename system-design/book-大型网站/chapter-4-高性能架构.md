## 大型网站的高性能架构

不同人员对网站性能的理解不一样，用户眼中的性能一般是响应速度，服务器开发人员眼中的性能除了请求的处理时间外，还有系统的吞吐量。在做性能优化或者高性能架构设计时，首先要捋清楚性能指标及对应的性能测试方法。

性能优化不仅仅需要关注服务器端程序，很多情况下，前端(或移动端)和存储系统同样可能成为系统性能的瓶颈。

少数情况下，性能优化的成本很高，性价比一般，或者甚至难以达到预期效果，可以考虑对产品形式进行调整，比如同步转异步，允许一定程度的数据延迟等。

### 性能指标/性能测试

#### 不同视角下的网站性能

**用户眼中的性能**

用户眼中的性能通常是从用户发出指令（点击）到用户看到结果的时间，包括请求到达服务器端的时间，服务器端的处理时间，处理结果发送到用户端的时间及用户端程序解析并呈现结果的时间。

不同终端的性能差异、不同的网络条件、不同浏览器解析速度差异，这些差异导致的延迟可能要远远高于服务器的处理时间。

系统开发人员可以通过设置CDN缓存、优化终端展示样式、设置反向代理等，使系统能够尽快展示用户感兴趣的内容，这样即使不优化应用系统本身的性能，用户视角的性能也会大大改善。

**开发眼中的性能**

开发人员眼中的性能主要是指系统本身及其子系统的处理效率，包括响应延迟、吞吐量、并发处理能力等，可以通过缓存、集群、异步等手段提高系统的处理效率。

**运维眼中的性能**

运维更关注基础资源的性能及资源的利用率，包括基础带宽、服务器硬件配置及服务器和贷款利用率等。可以通过建设优化骨干网，虚拟化技术等提升资源使用效率。

#### 性能指标

**响应时间**

响应时间是指系统从接受请求到返回请求所经历的时间，响应时间能够直观反映系统的处理速度和性能表现。

可以记录系统接收请求和处理完请求的时间，通过计算时间差来得到响应时间，通常使用计算多次请求的平均时间作为系统的响应时间，以此来消除记录时间本身消耗的时间的影响。

实际情况下，通常使用P99、P995、P999延迟来反映系统的响应时间。P99代表最慢的1%请求的平均响应时间。比如P99是12ms，代表最慢的1%的请求，平均响应时间是12ms。

**吞吐量**

吞吐量是指一段时间内，系统能够处理的请求数量。通常使用TPS指标表示系统的吞吐，TPS是系统每秒钟能处理的事务数量。除TPS外，还有HPS（HTTP数量）、QPS（每秒查询数量）。

性能优化的目的，除了降低请求的响应时间外，还要尽可能增大系统的吞吐量，最大化资源的利用率。

**并发数**

并发数是指系统能够同时处理的请求个数。高并发是网站系统设计和实现中常见的难点，通常，网站系统的在设计之初，系统运营人员能够给出在一定时间内，系统能够达到的用户规模，以此为基础，估算出在线用户数及最大并发数。这些指标会成为系统非功能设计的重要依据。

通常情况下，可以使用多线程来模拟多个用户的并发请求，为了真实模拟用户行为，一般会在两次请求时间加一个随机的思考时间。

**性能计数器**

性能计数器是指服务器本身的一些性能指标。包括系统负载、CPU利用率、对象和线程数、磁盘与网络I/O等指标。这些指标也是系统监控的重要依据，当指标超过一定阈值时，应该及时报警通知相关的运维和开发人员处理。

系统负载分为5分钟、10分钟和15分钟负载，负载值代表当前正在被CPU执行和等待被CPU执行的进程数之和。这个数字如果比CPU数量小很多，代表系统资源空闲比较高，资源利用率较低，反之，表示系统资源不足，影响了应用程序的性能。

####性能测试方法####

**性能测试**

以系统初期设置的性能目标作为预期，不断施加压力，验证在资源可接受的范围内系统的性能。

**负载测试**

不断增加并发请求数为系统加压，直到系统的某项或多项指标到达临界值，此时继续给系统加压，系统的处理能力反而会下降。

**压力测试**

超过安全负载的情况下，对系统不断增加压力直至系统崩溃，以此获得系统的最大承压能力。

**稳定性测试**

在给系统一定访问压力的情况下，让系统平稳的运行较长的一段时间，以此来测试系统是否稳定。对系统不均匀的施压以更好的模拟生产环境。

性能测试的目的，是测出：

1. 在哪些负载范围内，系统可以以较好的性能平稳运行，即网站的<b>平稳运行区间</b>。
2. 随着压力的增加，系统的处理能力增速开始变慢，直到一个<b>系统的最大负载点</b>。
3. 继续增加系统压力，系统处理能力开始下降，直到系统崩溃，不再处理请求，叨叨<b>系统崩溃点</b>

#####性能优化策略####

**性能分析**

性能优化前，需要对请求的各个环节进行性能分析，找出瓶颈所在，针对性的进行优化。定位性能问题切忌想当然。

一般可以结合监控数据进行分析，定位问题出在cpu、内存、磁盘还是网络，或是代码和架构不合理，或资源不足等。

**性能优化**

性能优化可以分为三大类：前端优化、服务器端优化及存储系统优化。

### 前端的高性能设计

网站前端一般包括浏览器加载、网站试图模型、图片服务、CDN服务等。通常有以下优化手段：

**动静分离**

浏览器端使用不同不同接口处理动态/静态内容，对动态/静态内容采用不同的优化方式。

**请求合并**

http请求通常建立在TCP请求之上，每次建立/销毁请求的开销比较大，减少http请求可以有效提升前端效率。可以通过合并css文件，合并图片、js文件等手段，减少http请求次数。

**传输数据压缩**

在服务器端压缩数据，在浏览器端对数据解压缩，可以有效减少要传输的数据大小，一般使用Gzip对内容进行压缩。压缩可以减少贷款的使用，一定程度上会增加服务器端和浏览器端的压力。

**减少cookie大小**

浏览器每次请求都会携带cookie，cookie过大影响传输效率。同时，对于静态资源的请求，可以尽少使用Cookie。

**客户端缓存**

浏览器可以缓存部分静态文件如CSS/JS/图片等，可以通过http头重的Cache-Control和Expire字段设置过期时间。如果服务器更新了CSS/JS/图片，可以通过改变文件名让浏览器重新加载。修改静态内容不宜同时大量修改，会增加浏览器端同时请求新内容的压力。

**CDN缓存**

CDN全名内容分发网络（Content Delivery Network），本质上是一个缓存，通过将内容放在离用户较劲的网络节点上，加速用户的访问。CDN可以缓存一些静态资源，包括脚本、图片、静态网页等。

**反向代理**

反向代理位于网站机房一侧，用户的请求首先访问反向代理服务器，然后由反向代理服务器将请求发送到具体的应用服务器。反向代理一般用于保护应用服务器安全，除了安全外，也可以在反向代理中设置缓存以加速内容访问。此外，反向代理可以作为负载均衡服务器，提升应用集群的总体处理能力。

### 服务器端的高性能设计

服务端缓存一般有添加缓存、服务异步化、服务集群化及代码本身的优化等手段。

####缓存

在进行性能优化时，缓存通常是第一个能想到的手段。

**缓存原理**

缓存通常是指将一些经常访问的数据放在存取效率更高的介质上，这些数据通常读写比比较高，在高效率的介质上能够提供更好的访问性能。也可以将一些需要计算的数据存放在缓存中，通过缓存避免重复计算。

缓存本质上是一张Hash表，通常情况下，Hash表的访问速度是O(1)。应用程序在访问应用数据时，首先访问缓存，如果缓存中没有数据，再去数据库，并将数据写入缓存。

**缓存的注意事项**

* 存放哪些数据

缓存通常存放一些读写比比较高的数据，如果将一些频繁修改的数据加入缓存，会增加缓存的维护成本，反而会降低系统性能。

同时，高效率的访问性能通常意味着更高的价格，一般情况下，我们不建议将全量数据加入缓存中，可以将一些热点数据放入缓存。

* 数据不一致

缓存一般要设置一定的超时时间，一旦过了失效时间要重新加载。此外，系统一般需要容忍缓存有一定的延迟。还有一定的策略是数据更新时立即更新缓存，不过这也会带来一定的缓存一致性问题。

* 缓存的可用性

缓存是加快数据访问性能使用的，如果缓存失效或事不可用，应用程序可以直接从数据库读数据，不会影响系统的可用性。

不过，如果系统访问量较大，缓存不可用时，将大量请求直接打到数据库，可能会造成数据库承受不了而宕机。可以使用分布式缓存中间件来提升缓存的可用性。

* 缓存预热

新启动的服务缓存中没有数据，在重建缓存的过程中，系统的性能和数据库负载可能会不好。那么最好在缓存启动时就把热点数据加载好，加载手段叫缓存预热。

* 缓存穿透

如果对系统中不存在的数据进行高并发访问，因为缓存中也没有该数据，可能造成频繁访问数据库，因此，可以考虑将没有活着null值也缓存起来。

**分布式缓存**

可以使用redis/memcached之类的分布式缓存中间件，相比于内存缓存，除了提供高性能的存取之外，也能够较好的保证缓存系统的高可用。

####异步

使用消息队列将同步操作异步化，通过对系统解耦合来提升系统的扩展性。同时，异步化也可以较好的起到流量削峰的作用，将高并发的访问平缓化。异步可能需要改变整个作业的流程。

####集群

集群化可以将用户请求分发到不同的服务器，从而减轻单个服务器的压力，起到优化性能的目的。

#### 代码优化

**多线程**

使用多线程主要有两个原因：IO阻塞与多CPU。一般情况下：

启动线程数 = 【任务执行时间 / （任务执行时间 - IO等待时间）】 * CPU内核数

如果一个任务是IO型任务，较多的线程数通常能够有效提升系统性能；如果一个任务时计算型任务，线程数一般不应超过CPU数量。

使用多线程要注意线程安全，线程安全的方式一般有：

* 无状态对象：如java web中的Servlet，不依赖内部状态，本身就是线程安全的。
* 局部变量
* 锁同步

**资源复用**

资源的创建/销毁比较耗费资源，使用池技术，使用资源时从池中取，用完时放回池中，可以有效提升资源使用效率。常见的池技术有线程池/数据库连接池等。

**GC优化**

GC优化是jvm优化的重要手段，可以通过选用合适的垃圾回收器、合适的内存分布来提升jvm gc的效率。此外，可以通过jvm gc-log、一些gc分析工具Jprofile等来分析JVM GC。

### 存储系统的高性能设计

**存储介质**

固态硬盘又称SSD，通过将数据存储在硅晶体中，可以像内存一样快速随机访问，相较于传统机械硬盘的磁头机械寻址方式性能有较大改善。但是SSD价格较高，而且工艺并不十分成熟，可靠性有待提升。

**B+树 vs LSM树**

B+树是专门针对磁盘的N叉树，在传统数据库系统中应用广泛。目前很多NoSql产品采用LSM树，在写数据时，不需要访问磁盘，在内存中即可完成；读数据时，如果内存中没有，会从磁盘读取。

**RAID vs HDFS**

RAID主要为了改善磁盘访问延迟，增强磁盘可用性和容错能力。HDFS以块儿为单位访问数据，HDFS在配合MapReduce等并行计算框架进行大数据处理时，可以在整个集群上并发读写访问所有的磁盘，无需RAID支持。

### 总结

网站性能优化的最终目的是改善用户体验，使用户觉得网站很快，离开这个目的，单纯追求技术的性能提升是舍本逐末。用户体验的快慢，除了用技术手段改善，也可以通过优化交互体验改善。

在技术层面，也要综合考虑，性能提升一倍，服务器数量增加一倍；或者响应时间缩短但是数据一致性下降，这样的优化是否可以接受。总之，技术是为业务服务的，技术的选型和架构依赖业务规划乃至企业的战略规划。

