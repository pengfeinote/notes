## 高可用架构

### 如何度量可用性

#### 可用性指标的计算方法

* 网站不可用时间：故障修复时间 - 故障发现(报告)时间
* 网站年度可用性指标：(1 - 不可用时间/年度总时间) * 100%
* 业界通常用几个9表达可用性。一般来讲，两个9代表基本可用，4个9代表极高的可用性，网站年度不可用时间小于53分钟
* qq的可用性达到了4个9，twitter的可用性不足两个9

#### 可用性指标考核

* 故障分级
	
	根据故障的严重程度可以对故障分级，业界常用P0/P1等表示故障等级，也可以使用以下方法为故障定级，原理基本一样。
	
	* 事故级: 严重故障，服务整体不可用。权重100
	* A类: 网站访问不顺畅或者核心功能不可用。权重20
	* B类: 非核心功能不可用，或核心功能少数用户不可用。权重5
	* C类: 以上故障之外。权重1

	故障分的计算公式：故障分 =.故障时间(分钟) * 权重。
	
	周期初可以根据可用性指标计算故障分，周期末根据实际故障分进行考核。
	
* 故障处理

	故障处理的流程
	
	* 故障发现(通过用户报告/监控发现)
	* 寻找故障接口人
	* 故障接手/定位/处理
	* 处理完毕,故障复盘/归档
	* 计算考核分

	>注：故障处理的第一原则是优先止损

	故障复盘方法
	
	* 故障过程review
		* 故障开始时间
		* 故障发现时间
		* 故障发现方法
		* 故障定位时间
		* 故障恢复时间
	* 故障影响总结
	* 事故原因分析：5why方法
	* 改进方案及追踪

### 可用性架构

大型网站一般采用分层架构，可以分为应用层、服务层及数据层。对于应用层而言，一般是无状态的http服务，可以通过集群部署+负载均衡器实现高可用；服务层的处理方式类似应用层，服务层一般通过注册中心(心跳检测)实现负载均衡；数据层的负载均衡相对复杂，为了保证数据再服务器宕机时不丢失，需要在写入时进行数据备份，在服务器宕机时将访问路由至可用的备份机。

### 应用层面的高可用

应用层想要保证高可用，首先应该是无状态的，然后使用负载均衡机制保证应用层高可用，负载均衡服务器通过心跳检测应用层服务的可用状态，主题剔除有问题的服务器。

#### session管理

* session复制: 将session复制到各应用层服务器，由于性能等原因该方法在大型服务中基本不可用
* session绑定：固定的用户访问固定的服务器，违反可用性原则，不推荐
* session放在cookie中：可以将少量信息放置在cookie中。缺点是受cookie大小限制，部分用户可能关闭cookie功能等
* 单独的session服务器: 单独的session服务管理session，应用服务器访问session服务实现相关功能。目前最常用的方式。

### 服务层面的高可用

建设高可用服务的几个必要方法：

* 分级管理

	* 首先需要对服务进行等级划分。例如对电商系统而言，用户支付功能显然比用户评价功能更重要。
	* 核心功能使用更好的硬件和带宽，优先保证可用。
	* 不同等级的服务进行隔离。以进程/虚拟机/物理机/机房/数据中心为维度进行隔离

* 超时设置

	* 服务自身应该对提供的功能进行超时设置，避免执行时间过长占用资源，甚至打满线程导致的不可用。
	* 应用程序可以通过访问框架重试请求或是到其他服务器进行请求

* 异步调用

	* 相比于同步调用，异步调用更利于功能层面的解耦避免相互影响，同时能起到流量削峰的目的
	* 对于需要确认下一步结果的请求，不适合异步调用
	* 理论上，流程中所有能够晚处理的事件应该尽量使用异步晚处理

* 服务降级

	* 面对流量洪峰，可以对非核心服务降级以保证核心功能的可用性
	* 降级方式有两种：拒绝服务、关闭服务
		* 拒绝服务：拒绝调用以减少并发数，节省资源。或者随机拒绝请求。
		* 关闭服务：关闭部分不重要的服务以节省开销

* 幂等性设计

	* 重试请求造成的结果应该是一致的，不能因为客户端多次请求而改变结果
	* 一般而言，可以通过固定ID/token等保证幂等性

### 数据层面的高可用

数据层面的高可用可以分为存储高可用和缓存高可用，存储高可用不能像应用/服务的高可用那样，使用简单的负载均衡实现。存储层面的高可用可以通过数据备份+失效转移实现。

数据层面的高可用应该考虑

* 数据存储的持久性：不能因为硬件损坏而丢失数据
* 数据的可访问性
* 数据一致性：如果数据有多个备份，应该保障备份数据一致

#### CAP原理

* C(一致性)
* A(可用性)
* P(分区容错性)

CAP原理认为，对于分布式存储系统而言，一致性、可用性及分区容错性同时只能满足两个。CAP原理对系统设计有重要意义，不要试图构建完美的系统，应该有所折衷。

多数情况下，会一定程度上放弃数据的一致性，而保障用户访问正常。

#### 数据一致性

* 强一致性:  各副本的数据总是一致的，如果一个更新操作响应成功，那么所有副本数据都已经更新成功。
* 用户一致性:  各副本存储的数据可能不一致，但用户访问时，通过一定的数据校验与转换，能够保证用户看到的数据是正确的
* 最终一致性:  允许副本数据在一定时间范围内不一致，用户访问也可能看到不一致的数据，但系统经过一定时间的恢复和修正，能够达到最终一致。

#### 数据备份

数据备份包括冷备和热备,  冷备通过定期复制实现，可能造成数据丢失和短期不可用；热备有同步热备和异步热备两种方式。同步热备指所有节点更新成功再返回成功，性能不友好，可靠性更强；异步热备指master更新成功即返回，性能友好但可靠性不如同步方式。一般而言，关键数据都会进行热备和冷备，保证关键数据万无一失。

#### 失效转移

当应用程序访问的存储系统出现问题时，需要将请求发送到其他存储服务器，这个过程称为失效转移。失效转移分为三步：

* 失效确认: 通过心跳 + 应用程序报告确定存储节点失效。应用程序报告后，还应通过心跳再次确认，以免判断错误。
* 请求转移: 计算路由，将请求重新路由到可用服务器中，如果存储系统不同节点的数据不一致，则需要做额外处理保障应用正确性。
* 数据恢复: 当原有存储节点失效时，需要及时将正确节点的数据恢复到新节点中，保证正常的副本数量。


### 高可用的流程保障


#### 代码管理

* 代码规范
* 代码管理规范：分支命名规范，分支管理规范(master/dev/staging)，commit log规范，分支合并规范
*  code review制度等

#### 发布管理

大型网站的迭代频率可能很高，对运行中的网站进行发布，好比给飞行中的飞机修改引擎，如果没有合理的发布流程进行保障，将会对网站可用性造成巨大威胁。

**自动化测试**

网站发布前，即便是很小的功能，也需要QA进行验证。此外，为了避免发布引入预料之外的bug，需要测试对整个网站的功能进行回归测试。

目前大部分网站都采用自动化测试技术，常用的自动化工具如Selenium等。

**预发布验证**

因为测试环境与线上环境不可能完全一致，因此在发布上线前需要在预发布环境进行验证。预发布环境和正式环境完全一致，只是没有部署在负载均衡器上，因此正常用户无法访问，开发人员可以自行配置在预发布环境进行验证。

需要注意的是，预发布环境虽然没有正常用户，但对预发布环境的改动可能影响线上，因此应格外小心。

**灰度发布**

大型网站发布/回滚一次可能耗时很长，一旦发布完成后发现有故障，可能经历长时间的回滚，期间只能眼睁睁看着故障发生。所谓灰度发布，是指现发布一小部分机器，观察一段时间没问题后再继续发布，尽可能减少故障带来的影响。

**自动化发布**

发布过程自动化程度越高，人的干预越少，出现故障的概率就越低。实际上自动化发布是目前网站发布的必要手段。

#### 监控管理

不允许没有监控的系统上线。运行没有监控的网站，犹如驾驶没有仪表盘的飞机。

**监控数据采集**

* 用户行为数据采集: 包括用户的点击数据、访问路径、停留时间等，这些数据对统计网站指标、优化用户行为等有重要意义。服务端与客户端均可记录用户行为。
* 性能监控：系统负载，磁盘IO，内存，网络IO等
* 业务监控：缓存命中率，平均响应时间，QPS，订单数等

**监控管理**

* 系统报警：监控指标超过阈值时需要触发报警，提醒相关人员处理。
* 失效转移：系统监控在发现故障时也可以自动进行失效转移。
* 自动优雅降级：监控系统分析监控指标，如果发现部分应用负载过高，部分应用负载过低，则自动卸载低负载应用并安装高负载应用，使总体均衡。

### 小结

对公司和个人而言，可用性都至关重要。不仅需要在技术上保障应用、服务、存储的高可用，还需要在流程上对软件的开发、测试、发布、监控进行保障，尽量降低可用性事故。
